@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HanapBuhay - Messages</title>
    <link rel="stylesheet" href="~/Styles/ChatPage_C_styles.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <img src="~/Images/HanapBuhay_Logo.png" alt="HanapBuhay Logo">
            </div>

            <div class="nav-links">
                <a href="@Url.Action("SearchPage_C", "Client")"><button class="home-btn"><ion-icon name="home-outline"></ion-icon></button></a>
                <a href="@Url.Action("Messages", "Client")"><button class="chat-btn active"><ion-icon name="chatbubble-ellipses-outline"></ion-icon></button></a>
                <a href="@Url.Action("Notifications", "Client")"><button class="notif-btn"><ion-icon name="notifications-outline"></ion-icon></button></a>
                <a href="@Url.Action("Profile", "Client")"><button class="profile-btn"><ion-icon name="person-outline"></ion-icon></button></a>
                <a href="@Url.Action("LandingPage", "Home")"><button class="logout-btn"><ion-icon name="log-in-outline"></ion-icon></button></a>
            </div>
        </div>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Left Sidebar -->
        <div class="chat-sidebar">
            <div class="chat-header">
                <h2>Messages</h2>
                <button class="new-chat-btn">
                    <ion-icon name="create-outline"></ion-icon>
                </button>
            </div>

            <div class="search-box">
                <div class="search-input-wrapper">
                    <ion-icon name="search-outline"></ion-icon>
                    <input type="text" class="search-input" placeholder="Search conversations...">
                </div>
            </div>

            <div class="chat-list">
                <!-- Conversations will be loaded dynamically -->
            </div>
        </div>

        <!-- Right Side - Chat Window -->
        <div class="chat-window">
            <div class="chat-window-header">
                <div class="current-chat-avatar">
                    <ion-icon name="person-outline"></ion-icon>
                </div>
                <div class="current-chat-info">
                    <h3>Select a conversation</h3>
                    <div class="current-chat-status">Active now</div>
                </div>
            </div>

            <div class="chat-messages">
                <div style="text-align: center; padding: 40px; color: #999;">
                    <ion-icon name="chatbubbles-outline" style="font-size: 60px; display: block; margin-bottom: 15px;"></ion-icon>
                    <p>Select a conversation to start messaging</p>
                </div>
            </div>

            <div class="chat-input-area">
                <button class="attach-btn">
                    <ion-icon name="add-circle-outline"></ion-icon>
                </button>
                <input type="text" class="chat-input" placeholder="Type a message...">
                <button class="send-btn">
                    <ion-icon name="send-outline"></ion-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Rate This Work</h2>
                <button class="modal-close" id="closeRatingBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>How was your experience with this worker?</p>
                
                <!-- Star Rating -->
                <div class="rating-stars" id="starRating">
                    <span class="star" data-rating="1">?</span>
                    <span class="star" data-rating="2">?</span>
                    <span class="star" data-rating="3">?</span>
                    <span class="star" data-rating="4">?</span>
                    <span class="star" data-rating="5">?</span>
                </div>
                
                <p id="ratingText" style="font-size: 12px; color: #999; margin-top: 10px;">Click a star to rate</p>
                
                <!-- Review Text -->
                <textarea id="reviewText" class="review-textarea" placeholder="Write your review (optional)" style="margin-top: 15px;"></textarea>
                
                <!-- Buttons -->
                <div style="margin-top: 20px;">
                    <button id="submitReviewBtn" class="btn-confirm">Submit Review</button>
                    <button id="cancelReviewBtn" class="btn-cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConversationId = null;
        let messageRefreshInterval = null;
        let lastLoadedMessageCount = 0;
        let selectedRating = 0;
        let currentJobRequestId = null;
        
        const chatWindowHeader = document.querySelector('.current-chat-info h3');
        const chatMessages = document.querySelector('.chat-messages');
        const chatInput = document.querySelector('.chat-input');
        const sendBtn = document.querySelector('.send-btn');
        const searchInput = document.querySelector('.search-input');
        const chatList = document.querySelector('.chat-list');
        const ratingModal = document.getElementById('ratingModal');
        const stars = document.querySelectorAll('.star');
        const ratingText = document.getElementById('ratingText');

        // Load conversations from database
        function loadConversations(search = '') {
            const url = search ? `/api/messages/conversations?search=${encodeURIComponent(search)}` : '/api/messages/conversations';
            
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(conversations => {
                    chatList.innerHTML = '';
                    
                    if (!conversations || conversations.length === 0) {
                        chatList.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No active conversations yet.</div>';
                        return;
                    }
                    
                    conversations.forEach(conv => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        chatItem.setAttribute('data-conversation-id', conv.conversationId);
                        
                        const truncatedMessage = (conv.lastMessage || 'No messages').length > 40 
                            ? (conv.lastMessage || 'No messages').substring(0, 40) + '...' 
                            : (conv.lastMessage || 'No messages');
                        
                        chatItem.innerHTML = `
                            <div class="chat-avatar" style="background: #FFE5B4;">
                                <ion-icon name="person-outline"></ion-icon>
                            </div>
                            <div class="chat-info">
                                <div class="chat-name">${conv.workerName}</div>
                                <div class="chat-preview">${truncatedMessage}</div>
                            </div>
                        `;
                        
                        chatItem.addEventListener('click', function() {
                            selectConversation(conv.conversationId, conv.workerName, this);
                        });
                        
                        chatList.appendChild(chatItem);
                    });
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    chatList.innerHTML = '<div style="padding: 20px; color: #d9534f;">Error loading conversations</div>';
                });
        }

        // Load messages from database
        function loadMessages(conversationId, forceRefresh = false) {
            fetch(`/api/client/messages/${conversationId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(messages => {
                    const shouldRefresh = forceRefresh || messages.length !== lastLoadedMessageCount;
                    
                    if (shouldRefresh) {
                        chatMessages.innerHTML = '';
                        lastLoadedMessageCount = messages.length;
                        
                        if (!messages || messages.length === 0) {
                            chatMessages.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">No messages yet. Start the conversation!</div>';
                            return;
                        }
                        
                        messages.forEach(msg => {
                            const messageDiv = document.createElement('div');
                            messageDiv.className = `message ${msg.isFromClient ? 'sent' : 'received'}`;
                            messageDiv.innerHTML = `
                                <div class="message-avatar">
                                    <ion-icon name="person-outline"></ion-icon>
                                </div>
                                <div class="message-content">
                                    <div class="message-sender">${msg.senderName || 'Unknown'}</div>
                                    <div class="message-bubble">${msg.content || ''}</div>
                                    <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                                </div>
                            `;
                            chatMessages.appendChild(messageDiv);
                        });
                        
                        // Auto scroll to bottom
                        setTimeout(() => {
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                        }, 0);
                    }
                })
                .catch(error => {
                    console.error('Error loading messages:', error);
                    chatMessages.innerHTML = `<div style="text-align: center; padding: 20px; color: red;">Error loading messages</div>`;
                });
        }

        // Select a conversation
        function selectConversation(conversationId, workerName, element) {
            currentConversationId = conversationId;
            chatWindowHeader.textContent = workerName;
            lastLoadedMessageCount = 0;
            
            // Clear previous interval
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
            
            // Remove active class from all items
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
                item.style.background = '';
            });
            
            // Add active class to clicked item
            element.classList.add('active');
            element.style.background = '#FFF8E7';
            
            // Load messages immediately
            loadMessages(conversationId, true);
            
            // Auto-refresh messages every 2 seconds
            messageRefreshInterval = setInterval(() => {
                loadMessages(conversationId, false);
            }, 2000);

            // ===== NEW: Check job status and show rating if needed =====
            checkJobStatus(conversationId);
        }

        // ===== NEW: Check if job is completed and show rating modal =====
        function checkJobStatus(conversationId) {
            fetch(`/api/client/job-status/${conversationId}`)
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Could not check job status');
                })
                .then(data => {
                    currentJobRequestId = data.jobRequestId;
                    
                    // Show rating modal only if job is completed and not yet reviewed
                    if (data.status === 'Completed' && !data.hasReview) {
                        showRatingModal();
                    } else if (data.status === 'Reviewed') {
                        // Job already reviewed, hide any rating prompts
                    }
                })
                .catch(error => {
                    console.error('Error checking job status:', error);
                });
        }

        // ===== NEW: Show rating modal =====
        function showRatingModal() {
            ratingModal.style.display = 'flex';
            resetRating();
        }

        // ===== NEW: Hide rating modal =====
        function hideRatingModal() {
            ratingModal.style.display = 'none';
        }

        // ===== NEW: Reset rating =====
        function resetRating() {
            selectedRating = 0;
            stars.forEach(star => {
                star.classList.remove('selected');
                star.style.color = '#ccc';
            });
            ratingText.textContent = 'Click a star to rate';
            document.getElementById('reviewText').value = '';
        }

        // ===== NEW: Star rating click handler =====
        stars.forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.getAttribute('data-rating'));
                
                stars.forEach((s, index) => {
                    if (index < selectedRating) {
                        s.classList.add('selected');
                        s.style.color = '#FFD700';
                    } else {
                        s.classList.remove('selected');
                        s.style.color = '#ccc';
                    }
                });
                
                const ratingTexts = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                ratingText.textContent = ratingTexts[selectedRating];
            });

            // Hover effect
            star.addEventListener('mouseover', function() {
                const hoverRating = parseInt(this.getAttribute('data-rating'));
                stars.forEach((s, index) => {
                    if (index < hoverRating) {
                        s.style.color = '#FFD700';
                    } else {
                        s.style.color = '#ccc';
                    }
                });
            });
        });

        // Hover out effect
        document.getElementById('starRating').addEventListener('mouseout', function() {
            stars.forEach((s, index) => {
                if (index < selectedRating) {
                    s.style.color = '#FFD700';
                } else {
                    s.style.color = '#ccc';
                }
            });
        });

        // ===== NEW: Submit review =====
        document.getElementById('submitReviewBtn').addEventListener('click', async function() {
            if (selectedRating === 0) {
                alert('Please select a star rating');
                return;
            }

            const reviewText = document.getElementById('reviewText').value.trim();

            try {
                const response = await fetch('/api/client/submit-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        JobRequestId: currentJobRequestId,
                        Rating: selectedRating,
                        ReviewText: reviewText
                    })
                });

                if (response.ok) {
                    alert('Thank you for your review!');
                    hideRatingModal();
                    // Reload conversations to update status
                    loadConversations();
                } else {
                    alert('Error submitting review. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error submitting review');
            }
        });

        // ===== NEW: Cancel review =====
        document.getElementById('cancelReviewBtn').addEventListener('click', function() {
            hideRatingModal();
        });

        // ===== NEW: Close rating modal =====
        document.getElementById('closeRatingBtn').addEventListener('click', function() {
            hideRatingModal();
        });

        // ===== NEW: Send message function =====
        async function sendMessage() {
            if (!currentConversationId) {
                alert('Please select a conversation first');
                return;
            }

            const messageText = chatInput.value.trim();

            if (messageText === '') return;

            sendBtn.disabled = true;

            try {
                const response = await fetch('/api/client/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ConversationId: currentConversationId,
                        Content: messageText
                    })
                });

                if (response.ok) {
                    chatInput.value = '';
                    // Force reload messages after sending
                    setTimeout(() => {
                        loadMessages(currentConversationId, true);
                    }, 100);
                } else {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    alert('Error sending message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                alert('Error sending message: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                chatInput.focus();
            }
        }

        // ===== Send button click event =====
        sendBtn.addEventListener('click', sendMessage);

        // ===== Send message with Enter key =====
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !sendBtn.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Load conversations on page load
        loadConversations();

        // Search conversations
        searchInput.addEventListener('input', function() {
            loadConversations(this.value);
        });

        // Cleanup interval when leaving page
        window.addEventListener('beforeunload', function() {
            if (messageRefreshInterval) {
                clearInterval(messageRefreshInterval);
            }
        });
    </script>
</body>
</html>
